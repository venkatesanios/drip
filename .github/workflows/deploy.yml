name: ğŸ›  Android CI / Build & Release AAB
#on:
#  workflow_dispatch:
on:
  push:
    branches: [ release ]
    tags: [ 'v*.*.*' ]
permissions:
  contents: write
  actions: read
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
jobs:
  #  build_and_release:
  #    runs-on: ubuntu-latest
  #    environment: ORO IntelliIrrigate Deployment
  #    steps:
  #      - name: ğŸ“‚ Checkout code
  #        uses: actions/checkout@v3
  #        with:
  #          fetch-depth: 0
  #      - name: ğŸ” Check secrets
  #        run: |
  #          echo "Keystore secret: ${{ secrets.KEYSTORE_BASE64 != '' && 'present' || 'missing' }}"
  #          echo "Google Play JSON: ${{ secrets.GOOGLE_PLAY_JSON != '' && 'present' || 'missing' }}"
  #          echo "Key alias: ${{ secrets.KEY_ALIAS }}"
  #      - name: ğŸš€ Cache pub deps
  #        uses: actions/cache@v3
  #        with:
  #          path: ~/.pub-cache
  #          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.yaml') }}
  #          restore-keys: ${{ runner.os }}-pub-
  ##      - name: â˜•ï¸ Setup Java (Temurin 17)
  ##        uses: actions/setup-java@v3
  ##        with:
  ##          distribution: temurin
  ##          java-version: '17'
  #      - name: ğŸ¦‹ Setup Flutter
  #        uses: subosito/flutter-action@v2
  #        with:
  #          channel: stable
  #          flutter-version: '3.27.3'
  #      - name: ğŸ“¥ Get dependencies
  #        run: flutter pub get
  #      - name: ğŸ”‘ Decode keystore
  #        run: |
  #          echo "${{ secrets.KEYSTORE_BASE64 }}" | tr -d '\n' | base64 -d > android/app/release-key.jks
  #      - name: ğŸ” Verify keystore
  #        run: |
  #          file android/app/release-key.jks
  #          keytool -list -keystore android/app/release-key.jks -storepass ${{ secrets.KEYSTORE_PASSWORD }}
  #        env:
  #          JAVA_HOME: ${{ env.JAVA_HOME_17_X64 }}
  #      - name: ğŸ” Create key.properties
  #        run: |
  #          echo "storePassword=${{ secrets.KEYSTORE_PASSWORD }}" > android/key.properties
  #          echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> android/key.properties
  #          echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> android/key.properties
  #          echo "storeFile=release-key.jks" >> android/key.properties
  #          echo "storeType=JKS" >> android/key.properties
  #      - name: ğŸ”¢ Update version code and name
  #        if: startsWith(github.ref, 'refs/tags/v')
  #        run: |
  #          # Extract version name from tag (e.g., v1.2.3 -> 1.2.3)
  #          VERSION_NAME=$(echo "${{ github.ref_name }}" | sed 's/^v//')
  #          # Dynamically calculate version code from commit count
  #          VERSION_CODE=$(git rev-list --count HEAD)
  #          # Update build.gradle
  #          sed -i "s/versionCode .*/versionCode $VERSION_CODE/" android/app/build.gradle
  #          sed -i "s/versionName .*/versionName \"$VERSION_NAME\"/" android/app/build.gradle
  #      - name: ğŸ—ï¸ Build APK
  #        run: flutter build apk --release --flavor oroProduction -t lib/main_oroProduction.dart
  #      - name: ğŸ—ï¸ Build AAB
  #        if: startsWith(github.ref, 'refs/tags/v')
  #        run: flutter build appbundle --release --flavor oroProduction -t lib/main_oroProduction.dart
  #      - name: ğŸ“¦ Prepare artifacts
  #        run: |
  #          mkdir -p artifacts
  #          cp build/app/outputs/apk/oroProduction/release/app-oroProduction-release.apk artifacts/
  #          if [[ "${{ github.ref }}" =~ ^refs/tags/v ]]; then
  #            cp build/app/outputs/bundle/oroProductionRelease/app-oroProduction-release.aab artifacts/
  #          fi
  #      - name: ğŸ·ï¸ Create or update Release
  #        if: startsWith(github.ref, 'refs/tags/v')
  #        uses: ncipollo/release-action@v1.16.0
  #        with:
  #          tag: ${{ github.ref_name }}
  #          name: Release ${{ github.ref_name }}
  #          artifacts: artifacts/*.apk,artifacts/*.aab
  #          token: ${{ secrets.GITHUB_TOKEN }}
  #      - name: ğŸ“¤ Upload to Play Store (Internal)
  #        if: startsWith(github.ref, 'refs/tags/v')
  #        uses: r0adkll/upload-google-play@v1
  #        with:
  #          serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_JSON }}
  #          packageName: com.niagaraautomations.oroDripirrigation
  #          releaseFiles: artifacts/app-oroProduction-release.aab
  #          track: production
  #          inAppUpdatePriority: 3
  #          status: completed
  #          changesNotSentForReview: false
  #  build_and_deploy_web:
  #    runs-on: ubuntu-latest
  #    environment: ORO WEB
  #    steps:
  #      - name: ğŸ“‚ Checkout code
  #        uses: actions/checkout@v3
  #
  #      - name: ğŸ¦‹ Setup Flutter
  #        uses: subosito/flutter-action@v2
  #        with:
  #          channel: stable
  #          flutter-version: '3.27.3'
  #
  #      - name: ğŸ“¥ Get dependencies
  #        run: flutter pub get
  #
  #      - name: Replace index.html
  #        run: cp web/oro/index.html web/index.html
  #
  #      - name: ğŸ—ï¸ Build Web
  #        run: flutter build web --release --target=lib/main_oroProduction.dart --web-renderer canvaskit
  #
  #      - name: ğŸš€ Copy files to EC2 via SCP
  #        uses: appleboy/scp-action@v0.1.7
  #        with:
  #          host: ${{ secrets.EC2_HOST }}
  #          username: ${{ secrets.EC2_USER }}
  #          key: ${{ secrets.EC2_SSH_KEY }}
  #          port: ${{ secrets.EC2_PORT || 22 }}
  #          source: "build/web/*"
  #          target: "/home/ec2-user/ORO/ORO_NEW/flutter_web"
  build_and_release_ios:
    runs-on: macos-latest
    environment: ORO iOS Deployment
    steps:
      - name: ğŸ“‚ Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: ğŸ¦‹ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version: '3.27.3'

      - name: ğŸ“¥ Get dependencies
        run: flutter pub get

      - name: ğŸ Setup Xcode
        run: sudo xcode-select -s /Applications/Xcode_16.4.app

      - name: ğŸ” Setup Code Signing
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_PROVISIONING_PROFILE: ${{ secrets.APPLE_PROVISIONING_PROFILE }}
        run: |
          set -euo pipefail
          echo "Starting code signing setup..."

          # Portable base64 decode (try --decode, -D, then -d)
          decode_base64() {
            local input="$1"
            local out="$2"
            if echo "$input" | base64 --decode > "$out" 2>/dev/null; then
              return 0
            fi
            if echo "$input" | base64 -D > "$out" 2>/dev/null; then
              return 0
            fi
            if echo "$input" | base64 -d > "$out" 2>/dev/null; then
              return 0
            fi
            return 1
          }

          echo "Decoding certificate..."
          if ! decode_base64 "$APPLE_CERTIFICATE" certificate.p12; then
            echo "Failed to decode APPLE_CERTIFICATE; ensure the secret is a base64 string" >&2
            exit 1
          fi

          # Create and configure a dedicated temporary keychain for the job
          KEYCHAIN_PASSWORD="github_actions"
          KEYCHAIN_NAME="build.keychain"
          KEYCHAIN_PATH="$HOME/Library/Keychains/$KEYCHAIN_NAME-db"

          echo "Creating keychain..."
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
          # Make the new keychain the default so codesign/xcodebuild will use it
          security default-keychain -s "$KEYCHAIN_NAME"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
          # Increase timeout to avoid unlock issues during long builds
          security set-keychain-settings -t 3600 -u "$KEYCHAIN_NAME"

          echo "Importing certificate into keychain..."
          security import certificate.p12 -k "$KEYCHAIN_PATH" -P "$APPLE_CERTIFICATE_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security

          echo "Adjusting key partition list to allow codesign/xcode to access the key..."
          # This step may fail on older macOS versions; continue on failure but warn
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH" || echo "Warning: set-key-partition-list failed (non-fatal)"

          echo "Installing provisioning profile..."
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          if ! decode_base64 "$APPLE_PROVISIONING_PROFILE" ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision; then
            echo "Failed to decode APPLE_PROVISIONING_PROFILE; ensure the secret is a base64 string" >&2
            exit 1
          fi

          echo "Code signing setup complete."

      - name: ğŸ—ï¸ Build IPA
        run: flutter build ipa --release --flavor oroProduction -t lib/main_oroProduction.dart

      - name: ğŸš€ Upload to App Store Connect
        uses: apple-actions/upload-testflight-build@v1
        with:
          app-path: build/ios/ipa/*.ipa
          issuer-id: ${{ secrets.APPSTORE_ISSUER_ID }}
          api-key-id: ${{ secrets.APPSTORE_API_KEY_ID }}
          api-private-key: ${{ secrets.APPSTORE_API_PRIVATE_KEY }}