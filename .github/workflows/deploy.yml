name: Deploy ORO IntelliIrrigate to Play Store

on:
  push:
    branches:
      - saravanan

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: ORO IntelliIrrigate Deployment
    env:
      FLUTTER_VERSION: "3.27.3"
      JAVA_VERSION: "17"
      FLAVOR: "oroProduction"
      AAB_PATH: "build/app/outputs/bundle/oroProductionRelease/app-oroProduction-release.aab"

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: ${{ env.JAVA_VERSION }}
          cache: "gradle"

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: "stable"
          cache: "true"

      - name: Install Dependencies
        run: flutter pub get

      - name: Clear Gradle Cache
        run: |
          rm -rf ~/.gradle/caches
          flutter clean

      - name: Decode Keystore
        run: echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > android/app/release-key.jks

      - name: Verify Keystore File
        run: ls -l android/app/release-key.jks

      - name: Validate Keystore
        run: keytool -list -keystore android/app/release-key.jks -storepass ${{ secrets.KEYSTORE_PASSWORD }} -v

      - name: Create key.properties
        run: |
          echo "storePassword=${{ secrets.KEYSTORE_PASSWORD }}" > android/key.properties
          echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> android/key.properties
          echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> android/key.properties
          echo "storeFile=app/release-key.jks" >> android/key.properties

      - name: Debug Environment Variables
        run: |
          echo "KEY_ALIAS is set: ${{ secrets.KEY_ALIAS != '' }}"
          echo "KEYSTORE_PASSWORD is set: ${{ secrets.KEYSTORE_PASSWORD != '' }}"
          echo "KEY_PASSWORD is set: ${{ secrets.KEY_PASSWORD != '' }}"

      - name: Build App Bundle
        run: flutter build appbundle --release --flavor ${{ env.FLAVOR }} --stacktrace
        env:
          CI: true

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.3.0"
          bundler-cache: true

      - name: Create Google Play JSON Key
        run: echo '${{ secrets.GOOGLE_PLAY_JSON }}' > android/google_play_api_key.json

      - name: Set up Fastlane
        run: |
          cd android
          gem install bundler
          bundle install || bundle init && echo "gem 'fastlane'" > Gemfile && bundle install
          bundle exec fastlane init
        env:
          FASTLANE_SKIP_UPDATE_CHECK: true

      - name: Configure Fastlane
        run: |
          cd android/fastlane
          echo "json_key_file('../google_play_api_key.json')" > Appfile
          echo "package_name('com.niagaraautomations.oroDripirrigation')" >> Appfile
          cat > Fastfile << 'EOF'
          default_platform(:android)
          platform :android do
            desc "Deploy to Play Store Internal Track"
            lane :internal do
              upload_to_play_store(
                track: 'internal',
                aab: '../../${{ env.AAB_PATH }}',
                skip_upload_metadata: true,
                skip_upload_images: true,
                skip_upload_screenshots: true,
                skip_upload_apk: true
              )
            end
          end
          EOF

      - name: Deploy to Play Store
        run: |
          cd android
          bundle exec fastlane internal